<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    .node circle {
      fill: #999;
    }

    .node text {
      font: 10px sans-serif;
    }

    .node--internal circle {
      fill: #555;
    }

    .node--internal text {
      text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
    }

    .link {
      fill: none;
      stroke: #555;
      stroke-opacity: 0.4;
      stroke-width: 1.5px;
    }

    form {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      position: absolute;
      left: 10px;
      top: 10px;
    }

    label {
      display: block;
    }
    #tree-container {
      overflow: hidden;
    }

    .links line {
      stroke: #999;
      stroke-opacity: 0.6;
    }

    .nodes circle {
      stroke: #fff;
      stroke-width: 1.5px;
    }

    text {
      font-family: sans-serif;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div id="author-svg"></div>
  <div id="tree-container"></div>

  <script src="../../js/jquery-1.10.2.min.js"></script>
  <!-- <script src="../../js/d3.v4.min.js"></script> -->
  <script src="../../js/d3.v4.js"></script>

  <script>
      var svg = d3v4.select("#author-svg")
                  .append("svg")
                  .attr("width", 960)
                  .attr("height", 400)
      var width = svg.attr("width"),
          height = svg.attr("height");

      var lastCName = null;

  
      var color = d3v4.scaleOrdinal(d3v4.schemeCategory20);
  
      var simulation = d3v4.forceSimulation()
          .force("link", d3v4.forceLink().id(function(d) { return d.id; }))
          .force("charge", d3v4.forceManyBody())
          .force("center", d3v4.forceCenter(width / 2, height / 2));
  
      d3v4.json("miserables.json", function(error, graph) {
        if (error) throw error;
  
        var link = svg.append("g")
            .attr("class", "links")
          .selectAll("line")
          .data(graph.links)
          .enter().append("line")
            .attr("stroke-width", function(d) { return Math.sqrt(d.value); });
  
        var node = svg.append("g")
            .attr("class", "nodes")
          .selectAll("g")
          .data(graph.nodes)
          .enter().append("g")
          .on("click", clickForceNode)
        
        function clickForceNode(d) {
          var cName = '.' + d.id; // 点击的作者名称
          // d3v4.selectAll('rect')
          d3v4.selectAll('.rect1')
            .style('fill', function(d) {
              return 'lightsteelblue'
            })
          if(lastCName) {
            d3v4.selectAll(lastCName)
              .select('rect')
              .style('fill', function(d) {
                return 'lightsteelblue'
              })
          }
          d3v4.selectAll(cName)
            .select('rect')
            .style('fill', function(d) {
              return 'red'
            })

          lastCName = cName;

          d3v4.select(this)
            .select('rect')
            .style('fill', function(d) {
              return '#336BA3'
            })
        }
          
        var circles = node.append("circle")
            .attr("r", 5)
            .attr("fill", function(d) { return color(d.group); })
            .call(d3v4.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
  
        var lables = node.append("text")
            .text(function(d) {
              return d.id;
            })
            .attr('x', 6)
            .attr('y', 3);
  
        node.append("title")
            .text(function(d) { return d.id; });
  
        simulation
            .nodes(graph.nodes)
            .on("tick", ticked);
  
        simulation.force("link")
            .links(graph.links);
  
        function ticked() {
          link
              .attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });
  
          node
              .attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
              })
        }
      });
  
      function dragstarted(d) {
        if (!d3v4.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
  
      function dragged(d) {
        d.fx = d3v4.event.x;
        d.fy = d3v4.event.y;
      }
  
      function dragended(d) {
        if (!d3v4.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    </script>
  <script>

tree = data => {
  const root = d3v4.hierarchy(data);
  const width = 960;
  root.dx = 30; // 更改link上下的高度
  root.dy = width / (root.height + 1);
  return d3v4.tree().nodeSize([root.dx, root.dy])(root);
}

var lastCName = null;

d3v4.json("flare-v4.json", function(error, data) {
  if (error) throw error;
  const root = tree(data);
  
  var zoomListener = d3v4.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
  function zoom() {
    baseSvg.attr("transform", "translate(" + d3v4.event.transform.x + "," + d3v4.event.transform.y + ") scale(" + d3v4.event.transform.k + ")");
  }

  var baseSvg = d3v4.select("#tree-container")
    .append("svg")
    .attr("width", 960)
    .attr("height", 400)
    .call(zoomListener);
  var g = baseSvg.append("g")
    .attr("transform", "translate(40,100)")

  
  function clickG(d) {
    var cName = '.' + d.data.id; // 点击的作者名称
    d3v4.selectAll('rect')
      .style('fill', function(d) {
        return 'lightsteelblue'
      })
    d3v4.select(this)
      .select('rect')
      .style('fill', function(d) {
        return '#336BA3'
      })
  }

  var link = g.selectAll(".link")
      .data(root.descendants().slice(1))
    .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);


  var node = g.selectAll(".node")
      .data(root.descendants())
    .enter().append("g")
      .attr("class", function(d) { 
        return "node " + d.data.id
        // return "node" + (d.children ? " node--internal" : " node--leaf"); 
      })
      .attr("transform", function(d) { 
        return "translate(" + d.y + "," + d.x + ")"; 
      })
    .on('click', clickG)

  node.append("rect")
      .attr('class', 'nodeCircle')
      .attr('class', 'rect1')
      .attr("width", 40)
      .attr("height", 22)
      .attr("x", 0)
      .attr("y", -11)
      .style("fill", function(d) {
          return "lightsteelblue";
      })

  node.append("text")
      .attr("dy", 3)
      .attr("x", function(d) {
        return 8; 
      })
      .style("text-anchor", function(d) { 
        return "start"; 
      })
      .text(function(d) { 
        return d.data.id
      });
});

function diagonal(d) {
  return "M" + d.y + "," + d.x
      + "C" + (d.parent.y + 100) + "," + d.x
      + " " + (d.parent.y + 100) + "," + d.parent.x
      + " " + d.parent.y + "," + d.parent.x;
}
  </script>
</body>
</html>